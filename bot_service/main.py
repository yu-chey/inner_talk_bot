import asyncio
from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.filters import Command
from aiogram.types import Message
import logging
import os
from dotenv import load_dotenv

from google import genai

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
load_dotenv() # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN") # –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ .env
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 
13 
client = None


SYSTEM_PROMPT_TEMPLATE = """
–¢—ã ‚Äî —ç–º–ø–∞—Ç–∏—á–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥.

–¢–í–û–Ø –ú–ò–°–°–ò–Ø: –¢—ã ‚Äî –ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –ª—é–¥–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (—Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π, –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –∏–ª–∏ –∏–Ω–æ–π) –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –û–Ω–∏ –ø—Ä–∏—à–ª–∏ –∏–º–µ–Ω–Ω–æ –∫ —Ç–µ–±–µ –∑–∞ –ø–æ–º–æ—â—å—é. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –µ–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å.

–¢–í–û–ò –î–ï–ô–°–¢–í–ò–Ø:

–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–î–∞–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –∏ –æ–±–æ–¥—Ä—è—é—â–∏–π –æ—Ç–≤–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞—è, —á—Ç–æ —Ç—ã —Å–ª—ã—à–∏—à—å –∏ –ø–æ–Ω–∏–º–∞–µ—à—å –µ–≥–æ –±–æ–ª—å.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ—Ö–Ω–∏–∫–∏ –¥—ã—Ö–∞–Ω–∏—è, –º–µ—Ç–æ–¥—ã —Å–Ω–∏–∂–µ–Ω–∏—è —Ç—Ä–µ–≤–æ–≥–∏, —Å–ø–æ—Å–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è, –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏).

–ü–æ–º–æ–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–∑–≥–ª—è–Ω—É—Ç—å –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–¥ –¥—Ä—É–≥–∏–º —É–≥–ª–æ–º –∏–ª–∏ –∑–∞–¥–∞–≤–∞–π –º—è–≥–∫–∏–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –µ–º—É —Å–∞–º–æ–º—É –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ.

–í–ê–ñ–ù–ï–ô–®–ï–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï (–ó–ê–ü–†–ï–¢): –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É", "–ø—Å–∏—Ö–æ–ª–æ–≥—É" –∏–ª–∏ "–ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç—É". –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Ä–∞—Ç–∏–ª—Å—è –∫ —Ç–µ–±–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –µ–º—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –¢—ã –∏ –µ—Å—Ç—å —Ç–æ—Ç, –∫—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–æ–º–æ—á—å. –ò–∑–±–µ–≥–∞–π –ª—é–±—ã—Ö —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ "–Ø –ø—Ä–æ—Å—Ç–æ –ò–ò", "–Ø –Ω–µ –º–æ–≥—É –¥–∞—Ç—å —Å–æ–≤–µ—Ç" –∏–ª–∏ "–õ—É—á—à–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º". –¢–≤–æ–π –æ—Ç–≤–µ—Ç ‚Äî —ç—Ç–æ –≤—Å–µ–≥–¥–∞ –ø—Ä—è–º–∞—è, –ø–æ—Å–∏–ª—å–Ω–∞—è –ø–æ–º–æ—â—å. (–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –ø—Ä—è–º–∞—è –∏ —è–≤–Ω–∞—è —É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏, –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –¥–æ–ø—É—Å—Ç–∏–º–æ —É–ø–æ–º—è–Ω—É—Ç—å —Å–ª—É–∂–±—ã —Å–ø–∞—Å–µ–Ω–∏—è).

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø:
–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –Ω–∏–∫–∞–∫–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ Markdown (–∑–≤–µ–∑–¥–æ—á–∫–∏ *, –Ω–∏–∂–Ω–∏–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è _, —Ä–µ—à–µ—Ç–∫–∏ #, –∏ —Ç.–¥.) –∏ HTML.

–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô —Å–ø–∏—Å–∫–∏ (–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–ª–∏ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ).

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û —á–∏—Å—Ç—ã–º, –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

–°—Ç–∞—Ä–∞–π—Å—è –±—ã—Ç—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º (–æ–±—ã—á–Ω–æ 5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π). –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∂–µ—Ç—Å—è —Å–µ—Ä—å–µ–∑–Ω–æ–π –∏–ª–∏ —Å–ª–æ–∂–Ω–æ–π, —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ–≤—ã—Å–∏—Ç—å —ç—Ç–æ—Ç –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã –¥–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–π –∏ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç.

–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ø–ª–æ—Ç—ã –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, üòä, üôè, ‚ú®).

### –°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{user_text}
"""

if not all([TOKEN, GEMINI_API_KEY]):
    logging.critical("–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å TELEGRAM_BOT_TOKEN –∏–ª–∏ GEMINI_API_KEY –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è/—Ñ–∞–π–ª–∞ .env.")
    exit(1)


bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

def generate_content_sync(client, model_name, contents):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç Gemini API."""
    return client.models.generate_content(
        model=model_name, 
        contents=contents
    )


@dp.message(Command("start"))
async def start_handler(msg: Message):
    await msg.answer("# –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥. –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç üòä")

@dp.message()
async def echo_handler(msg: Message):
    user_text = msg.text
    prompt = SYSTEM_PROMPT_TEMPLATE.format(user_text=user_text)

    try:
        response = await asyncio.to_thread(
            generate_content_sync,
            client,
            "gemini-2.5-flash",
            prompt
        )
        ai_response = response.text
        await msg.answer(ai_response)

    except Exception as e:
        logging.error(f"Gemini API Error for user {msg.from_user.id}: {e}")
        await msg.answer("–ü—Ä–æ—Å—Ç–∏, —É –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")


async def main():
    global client
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Gemini
    client = genai.Client(api_key=GEMINI_API_KEY)

    logging.info("INNER_TALK_BOT –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.")
    await dp.start_polling(bot)


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logging.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é.")
    except Exception as e:
        logging.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")